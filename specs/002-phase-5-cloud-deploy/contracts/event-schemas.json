{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Evolution of Todo - Phase 5 Event Schemas",
  "description": "Kafka event schemas for Phase 5 event-driven architecture",
  "definitions": {
    "CloudEventsEnvelope": {
      "type": "object",
      "description": "CloudEvents v1.0 envelope wrapping all events",
      "required": ["specversion", "type", "source", "id", "time", "data"],
      "properties": {
        "specversion": {
          "type": "string",
          "const": "1.0"
        },
        "type": {
          "type": "string",
          "description": "Event type in reverse-DNS format"
        },
        "source": {
          "type": "string",
          "description": "Source service that generated the event"
        },
        "id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique event identifier"
        },
        "time": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when event was created"
        },
        "datacontenttype": {
          "type": "string",
          "const": "application/json"
        },
        "data": {
          "type": "object",
          "description": "Event payload"
        }
      }
    },
    "Priority": {
      "type": "string",
      "enum": ["high", "medium", "low"]
    },
    "RecurringPattern": {
      "type": ["string", "null"],
      "enum": ["daily", "weekly", "monthly", null]
    },
    "TaskEventType": {
      "type": "string",
      "enum": ["created", "updated", "completed", "deleted"]
    },
    "ReminderEventType": {
      "type": "string",
      "enum": ["scheduled", "due", "cancelled"]
    },
    "TaskUpdateAction": {
      "type": "string",
      "enum": ["created", "updated", "completed", "deleted", "reminder"]
    },
    "TaskData": {
      "type": "object",
      "required": ["title", "completed", "priority"],
      "properties": {
        "title": {
          "type": "string",
          "maxLength": 200
        },
        "description": {
          "type": ["string", "null"],
          "maxLength": 1000
        },
        "completed": {
          "type": "boolean"
        },
        "priority": {
          "$ref": "#/definitions/Priority"
        },
        "due_date": {
          "type": ["string", "null"],
          "format": "date-time"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "recurring_pattern": {
          "$ref": "#/definitions/RecurringPattern"
        },
        "next_occurrence": {
          "type": ["string", "null"],
          "format": "date-time"
        }
      }
    }
  },
  "topics": {
    "task-events": {
      "description": "Task lifecycle events (create, update, complete, delete)",
      "producers": ["backend"],
      "consumers": ["recurring-task-service", "audit-service", "websocket-service"],
      "schema": {
        "type": "object",
        "required": ["event_type", "task_id", "user_id", "task_data", "timestamp", "correlation_id"],
        "properties": {
          "event_type": {
            "$ref": "#/definitions/TaskEventType"
          },
          "task_id": {
            "type": "integer",
            "description": "Task identifier"
          },
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "User who owns the task"
          },
          "task_data": {
            "$ref": "#/definitions/TaskData"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When the event occurred"
          },
          "correlation_id": {
            "type": "string",
            "format": "uuid",
            "description": "Request tracing identifier"
          }
        },
        "examples": [
          {
            "event_type": "created",
            "task_id": 123,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "task_data": {
              "title": "Complete Phase 5 implementation",
              "description": "Implement event-driven architecture",
              "completed": false,
              "priority": "high",
              "due_date": "2026-01-15T10:00:00Z",
              "tags": ["work", "hackathon"],
              "recurring_pattern": null,
              "next_occurrence": null
            },
            "timestamp": "2026-01-10T14:30:00Z",
            "correlation_id": "7b9e8f6a-5c4d-3e2b-1a0f-9e8d7c6b5a4f"
          },
          {
            "event_type": "completed",
            "task_id": 456,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "task_data": {
              "title": "Weekly standup",
              "description": null,
              "completed": true,
              "priority": "medium",
              "due_date": "2026-01-13T09:00:00Z",
              "tags": ["meetings"],
              "recurring_pattern": "weekly",
              "next_occurrence": "2026-01-20T09:00:00Z"
            },
            "timestamp": "2026-01-13T09:30:00Z",
            "correlation_id": "1a2b3c4d-5e6f-7a8b-9c0d-e1f2a3b4c5d6"
          }
        ]
      }
    },
    "reminders": {
      "description": "Reminder scheduling and delivery events",
      "producers": ["backend", "dapr-jobs"],
      "consumers": ["notification-service"],
      "schema": {
        "type": "object",
        "required": ["event_type", "reminder_id", "task_id", "user_id", "title", "remind_at", "correlation_id"],
        "properties": {
          "event_type": {
            "$ref": "#/definitions/ReminderEventType"
          },
          "reminder_id": {
            "type": "integer",
            "description": "Reminder identifier"
          },
          "task_id": {
            "type": "integer",
            "description": "Associated task identifier"
          },
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "User to notify"
          },
          "title": {
            "type": "string",
            "description": "Task title for notification display"
          },
          "due_at": {
            "type": ["string", "null"],
            "format": "date-time",
            "description": "Task due date (if set)"
          },
          "remind_at": {
            "type": "string",
            "format": "date-time",
            "description": "When reminder was scheduled for"
          },
          "correlation_id": {
            "type": "string",
            "format": "uuid",
            "description": "Request tracing identifier"
          }
        },
        "examples": [
          {
            "event_type": "scheduled",
            "reminder_id": 789,
            "task_id": 123,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "title": "Complete Phase 5 implementation",
            "due_at": "2026-01-15T10:00:00Z",
            "remind_at": "2026-01-15T09:00:00Z",
            "correlation_id": "7b9e8f6a-5c4d-3e2b-1a0f-9e8d7c6b5a4f"
          },
          {
            "event_type": "due",
            "reminder_id": 789,
            "task_id": 123,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "title": "Complete Phase 5 implementation",
            "due_at": "2026-01-15T10:00:00Z",
            "remind_at": "2026-01-15T09:00:00Z",
            "correlation_id": "7b9e8f6a-5c4d-3e2b-1a0f-9e8d7c6b5a4f"
          }
        ]
      }
    },
    "task-updates": {
      "description": "Real-time task sync events for WebSocket broadcast",
      "producers": ["backend", "notification-service", "recurring-task-service"],
      "consumers": ["websocket-service"],
      "schema": {
        "type": "object",
        "required": ["event_type", "task_id", "user_id", "action", "timestamp"],
        "properties": {
          "event_type": {
            "type": "string",
            "enum": ["sync", "reminder"]
          },
          "task_id": {
            "type": "integer",
            "description": "Task identifier"
          },
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "User whose clients should receive update"
          },
          "action": {
            "$ref": "#/definitions/TaskUpdateAction"
          },
          "changes": {
            "type": "object",
            "description": "Changed fields (for partial updates)",
            "additionalProperties": true
          },
          "task_data": {
            "$ref": "#/definitions/TaskData",
            "description": "Full task data (for created events)"
          },
          "notification_message": {
            "type": "string",
            "description": "Message to display for reminder notifications"
          },
          "source_client": {
            "type": "string",
            "enum": ["web", "mobile", "api", "notification", "recurring"],
            "default": "api"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        },
        "examples": [
          {
            "event_type": "sync",
            "task_id": 123,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "action": "completed",
            "changes": {
              "completed": true
            },
            "source_client": "web",
            "timestamp": "2026-01-10T14:30:00Z"
          },
          {
            "event_type": "reminder",
            "task_id": 123,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "action": "reminder",
            "notification_message": "Task 'Complete Phase 5 implementation' is due in 1 hour!",
            "source_client": "notification",
            "timestamp": "2026-01-15T09:00:00Z"
          },
          {
            "event_type": "sync",
            "task_id": 789,
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "action": "created",
            "task_data": {
              "title": "Weekly standup (Next)",
              "description": null,
              "completed": false,
              "priority": "medium",
              "due_date": "2026-01-20T09:00:00Z",
              "tags": ["meetings"],
              "recurring_pattern": "weekly",
              "next_occurrence": "2026-01-27T09:00:00Z"
            },
            "source_client": "recurring",
            "timestamp": "2026-01-13T09:30:00Z"
          }
        ]
      }
    }
  },
  "dapr_pubsub_config": {
    "name": "kafka-pubsub",
    "type": "pubsub.kafka",
    "metadata": {
      "brokers": {
        "local": "redpanda:9092",
        "production": "${REDPANDA_BROKERS}"
      },
      "consumerGroup": "{appid}-group",
      "authRequired": "true (production)",
      "saslMechanism": "SCRAM-SHA-256 (production)"
    }
  },
  "subscriptions": {
    "recurring-task-service": {
      "pubsubname": "kafka-pubsub",
      "topic": "task-events",
      "route": "/api/events/task-completed",
      "metadata": {
        "rawPayload": "false"
      }
    },
    "audit-service": {
      "pubsubname": "kafka-pubsub",
      "topic": "task-events",
      "route": "/api/events/task",
      "metadata": {
        "rawPayload": "false"
      }
    },
    "notification-service": {
      "pubsubname": "kafka-pubsub",
      "topic": "reminders",
      "route": "/api/events/reminder",
      "metadata": {
        "rawPayload": "false"
      }
    },
    "websocket-service": {
      "pubsubname": "kafka-pubsub",
      "topics": ["task-events", "task-updates"],
      "routes": {
        "task-events": "/api/events/task",
        "task-updates": "/api/events/update"
      }
    }
  }
}
