apiVersion: v1
kind: Secret
metadata:
  name: {{ include "todo-app.fullname" . }}-secrets
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database connection (Neon PostgreSQL)
  # IMPORTANT: Set this value when deploying
  # Example: postgresql://user:password@host:5432/database?sslmode=require
  DATABASE_URL: {{ .Values.secrets.databaseUrl | quote }}

  # Frontend Database URL (Node.js pg driver format - without +asyncpg)
  # Automatically converted from DATABASE_URL
  FRONTEND_DATABASE_URL: {{ .Values.secrets.databaseUrl | replace "postgresql+asyncpg://" "postgresql://" | replace "?ssl=require" "?sslmode=require" | quote }}

  # AI/LLM API Keys
  # IMPORTANT: Set this value when deploying
  GEMINI_API_KEY: {{ .Values.secrets.geminiApiKey | quote }}

  # Authentication Secret
  # IMPORTANT: Set this value when deploying
  BETTER_AUTH_SECRET: {{ .Values.secrets.betterAuthSecret | quote }}

  # JWT Secret Key (required for backend auth)
  # Generate with: openssl rand -base64 32
  SECRET_KEY: {{ .Values.secrets.secretKey | default .Values.secrets.betterAuthSecret | quote }}

  # OpenAI ChatKit Domain Key (Frontend)
  # IMPORTANT: Set this value when deploying
  NEXT_PUBLIC_OPENAI_DOMAIN_KEY: {{ .Values.secrets.openaiDomainKey | quote }}
---
{{- if and .Values.ingress.auth .Values.ingress.auth.enabled (eq .Values.ingress.auth.type "basic") }}
# Basic Auth secret for Ingress (T048a)
# Generate htpasswd: htpasswd -nb username password
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "todo-app.fullname" . }}-basic-auth
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
type: Opaque
stringData:
  auth: {{ htpasswd .Values.secrets.basicAuthUsername .Values.secrets.basicAuthPassword | quote }}
{{- end }}
